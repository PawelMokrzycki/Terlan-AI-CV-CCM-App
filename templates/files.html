{% extends 'base.html' %}
{% block content %}
<div class="card shadow-soft p-5 my-5 rounded-4" style="max-width:1100px; margin:auto;">
  <h2 class="mb-4 text-center">Wyślij plik do analizy</h2>

  <form method="post" enctype="multipart/form-data" id="uploadForm">
    <div id="dropzone" class="p-4 mb-4 rounded-4 text-center"
      style="border:2px dashed #b3c3ce; background:#eaf2f7; min-height:180px; border-radius:28px;">
      <div style="margin-top:15px;">
        <svg width="56" height="56" style="opacity:.28">
          <g>
            <line x1="28" y1="15" x2="28" y2="36" style="stroke:#4c667a;stroke-width:3"/>
            <polyline points="20,30 28,38 36,30" style="fill:none;stroke:#4c667a;stroke-width:3"/>
            <line x1="14" y1="44" x2="42" y2="44" style="stroke:#4c667a;stroke-width:2"/>
          </g>
        </svg>
      </div>
      <div style="font-size:1.18em; margin-top:8px;">
        <b style="color:#2d4673;">Wybierz plik</b> lub przeciągnij tutaj.
      </div>
      <input type="file" name="file" id="fileInput" style="display:none;" required>
      <button type="button" class="btn btn-outline-secondary rounded-pill mt-3 mb-1"
              style="min-width:130px"
              onclick="document.getElementById('fileInput').click()">
        Wybierz plik
      </button>
    </div>
  </form>

  <h5 class="mb-3 mt-2">Twoje pliki:</h5>
  <div class="px-2">
    <ul class="list-group list-group-flush">
      {% for file in files %}
        <li class="list-group-item d-flex flex-column flex-md-row align-items-center justify-content-between mb-2 rounded-3" style="background:#ffffff;">
          <div class="flex-grow-1">
            <span class="fw-semibold">{{ file.nazwa }}</span>
            <br>
            <small class="text-muted">Dodano: {{ file.data_dodania }}</small>
          </div>
          <div class="d-flex gap-2 align-items-center mt-2 mt-md-0">
            <span class="badge bg-secondary px-3 py-2">{{ file.status }}</span>
            <button class="btn btn-outline-success btn-sm rounded-pill px-3"
                onclick="showPreview('{{url_for('uploaded_file', filename=file.nazwa)}}', '{{ file.nazwa }}')">
              Odtwórz
            </button>
          </div>
        </li>
      {% else %}
        <li class="list-group-item text-muted rounded-3">Brak plików do wyświetlenia.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
dropzone.addEventListener('dragover', e => {
    e.preventDefault(); dropzone.style.background='#eff5fa';
});
dropzone.addEventListener('dragleave', e => {
    e.preventDefault(); dropzone.style.background='#eaf2f7';
});
dropzone.addEventListener('drop', e => {
    e.preventDefault(); dropzone.style.background='#eaf2f7';
    if(e.dataTransfer.files.length>0){
        fileInput.files = e.dataTransfer.files;
        document.getElementById('uploadForm').submit();
    }
});
fileInput.addEventListener('change', function(){ if(this.files.length){ document.getElementById('uploadForm').submit(); } });

function showPreview(url, file) {
  const id = "preview-" + file.replaceAll('.', '_');
  document.querySelectorAll('div[id^="preview-"]').forEach(div => { div.innerHTML=""; });
  document.getElementById(id).innerHTML = `
    <video width="400" controls style="margin-top:8px; border-radius:12px; box-shadow: 0 4px 18px -8px #7bd2ad42;">
      <source src="${url}" type="video/mp4">
      <source src="${url}" type="video/webm">
      <source src="${url}" type="video/ogg">
      Nie można odtworzyć pliku w tej przeglądarce.
    </video>
  `;
}
</script>
{% endblock %}
