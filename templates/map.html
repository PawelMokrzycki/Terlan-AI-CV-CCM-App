{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-4">
  <h2 class="mb-3">Mapa GESUT – uzbrojenie & zrzuty</h2>
  <div class="d-flex justify-content-between align-items-center mb-2" style="gap:18px;">
    <!-- LEGEND/ACTIONBAR jak wcześniej -->
    <div class="d-flex flex-wrap align-items-center" style="gap:16px;">
      <span style="font-weight:600; font-size:1.12em;">Warstwy:</span>
      <form id="layers-form" class="d-flex flex-wrap align-items-center" style="gap:16px;">
        <label class="layer-row" style="cursor:pointer;"><input type="checkbox" checked id="wodo"><span class="cbx-color" data-cbx="#2196f3"></span><span class="ms-1">Sieć wodociągowa</span></label>
        <label class="layer-row" style="cursor:pointer;"><input type="checkbox" checked id="kanal"><span class="cbx-color" data-cbx="#607d8b"></span><span class="ms-1">Sieć kanalizacyjna</span></label>
        <label class="layer-row" style="cursor:pointer;"><input type="checkbox" checked id="gaz"><span class="cbx-color" data-cbx="#fbc02d"></span><span class="ms-1">Sieć gazowa</span></label>
        <label class="layer-row" style="cursor:pointer;"><input type="checkbox" checked id="el"><span class="cbx-color" data-cbx="#d32f2f"></span><span class="ms-1">Sieć elektroenergetyczna</span></label>
        <label class="layer-row" style="cursor:pointer;"><input type="checkbox" checked id="cieplo"><span class="cbx-color" data-cbx="#ff7c23"></span><span class="ms-1">Sieć ciepłownicza</span></label>
        <label class="layer-row" style="cursor:pointer;"><input type="checkbox" checked id="tel"><span class="cbx-color" data-cbx="#32cf32"></span><span class="ms-1">Sieć telekomunikacyjna</span></label>
      </form>
    </div>
    <div class="d-flex align-items-center" style="gap:18px;">
      <button id="download-map-btn" class="zrzut-gradient px-5 py-2 fw-bold rounded-pill" style="font-size: 1.12em;">Zrób zrzut mapy</button>
      <span id="spinner-btn" style="display:none;"><span class="spinner-border text-warning" role="status" style="width:2rem;height:2rem;"><span class="visually-hidden">Czekaj...</span></span></span>
    </div>
  </div>
  <div id="mymap" style="width: 97vw; height: 730px; max-width: 99vw; margin:0 auto 18px auto; border-radius:22px; box-shadow: 0 2px 32px -7px #23448844;"></div>
  <div class="mt-3">
    <h4 class="mb-3" style="font-size:1.12em;">Lista zrzutów mapy</h4>
    <table class="table table-bordered table-sm align-middle bg-white" id="snapshots-list" style="max-width:900px; table-layout:fixed;">
      <thead>
        <tr>
          <th style="width:180px;">Nazwa pliku</th>
          <th style="width:145px;">Godzina</th>
          <th style="width:85px;">Użytkownik</th>
          <th style="width:102px;">Podgląd</th>
          <th style="width:78px;">Usuń</th>
        </tr>
      </thead>
      <tbody>
        {% for s in snaps %}
        <tr data-snapfile="{{ s.filename }}">
          <td style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ s.filename }}</td>
          <td>{{ s.date }}</td>
          <td>{{ s.user }}</td>
          <td class="text-center"><img src="{{ url_for('map_snap', filename=s.filename) }}" alt="podgląd" class="previewImg" style="height:44px; width:96px; object-fit:cover; border-radius:7px; cursor:pointer" /></td>
          <td class="text-center"><button class="btn btn-delete rounded-pill px-3 fw-bold delete-snap-btn" style="height:38px; min-width:56px;">Usuń</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="big-preview" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(32,32,32,.72); z-index:9999; align-items:center; justify-content:center;">
    <img src="" style="max-width:85vw; max-height:85vh; box-shadow:0 6px 42px #222;" />
  </div>
  <div id="map-name-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(32,32,32,.12); z-index:99999; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:42px; border-radius:32px; box-shadow:0 8px 52px #13448844; display:flex; flex-direction:column; align-items:center; min-width:330px;">
      <label class="form-label" style="font-weight:600;text-align:left;width:100%;">Nazwa pliku zrzutu:</label>
      <input id="map-name-input" type="text" class="form-control mb-2" style="width:320px; height:48px; font-size:1.28em;" maxlength="80" value="">
      <div class="d-flex justify-content-between" style="width:320px">
        <button id="save-map-btn" class="zrzut-gradient rounded-pill px-4 fw-bold" style="min-width:120px; height:46px;">Zapisz</button>
        <button id="cancel-map-btn" class="btn btn-light rounded-pill px-4 fw-bold" style="min-width:120px; height:46px; border:2px solid #ddd;">Anuluj</button>
      </div>
    </div>
  </div>
</div>
<style>
.zrzut-gradient {
  background: linear-gradient(90deg, #f9d423 20%, #ffdc80 100%);
  color: #644000 !important; border: none;
  box-shadow: 0 4px 18px -6px #23448844; border-radius:22px;
  font-weight:700; font-size:1.1em;
  transition: box-shadow .18s, background .16s, color .16s;
}
.zrzut-gradient:active, .zrzut-gradient:focus { color:#000 !important; box-shadow: 0 2px 10px -7px #23448844; background:#ffe585; }
.zrzut-gradient:hover { background:#ffe585; color:#ca8a00 !important; }
.btn-delete {
  background: #fff; color: #ff3b3b;
  border: 2px solid #ff3b3b; border-radius: 22px; margin:0 auto;
  transition: background .13s, color .12s, border .13s;
  font-weight:700; font-size:1.08em; display:inline-block;
  min-width:120px; height:44px; vertical-align:middle;
  padding-top: 7px; padding-bottom: 7px;
}
.btn-delete:hover, .btn-delete:focus { background: #ff3b3b; color: #fff !important; border-color: #ff3b3b;}
.large-label-textarea {
  font-size: 1.16em; width: 98%; min-height: 87px; resize: vertical;
  padding: 12px 13px; border-radius: 14px; border: 2px solid #ddd; margin-bottom: 14px;
  font-family: inherit; white-space: pre-line !important;
}
.cbx-color { display: inline-block; width: 20px; height: 20px; border-radius:3px; margin-bottom:0; margin-right:4px; border:2.5px solid #dedede; cursor:pointer; background: #fff; transition:background .14s, border .16s; vertical-align: middle;}
#layers-form input[type=checkbox] { position: absolute; left: -100vw; background: none; width:0; height:0; margin:0; padding:0; border:none; }
#layers-form input[type=checkbox] + .cbx-color { background: #fff !important; border:2px solid #e3e3e3; box-shadow: none;}
#layers-form input[type=checkbox]:checked + .cbx-color { background: var(--active-color, #ccc) !important; border-color: var(--active-color, #aaa) !important; box-shadow: 0 0 7px 2px var(--active-color, #aaa)33;}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
let lastFileName = "";
document.getElementById("download-map-btn").addEventListener("click", function() {
  document.getElementById("map-name-input").value = "";
  document.getElementById("map-name-modal").style.display = "flex";
});
document.getElementById("cancel-map-btn").onclick = function(){
  document.getElementById("map-name-modal").style.display = "none";
};
document.getElementById("save-map-btn").onclick = function(){
  document.getElementById("map-name-modal").style.display = "none";
  var name = document.getElementById("map-name-input").value.trim();
  lastFileName = name || "";
  document.getElementById("spinner-btn").style.display = "inline-block";
  var mapDiv = document.getElementById("mymap");
  html2canvas(mapDiv, {useCORS:true, backgroundColor: null}).then(function(canvas) {
    document.getElementById("spinner-btn").style.display = "none";
    var fd = new FormData();
    fd.append('img', dataURLtoBlob(canvas.toDataURL("image/png")));
    fd.append('username', 'Paweł');
    fd.append('filename', lastFileName);
    fetch("/upload_map_snap", {method: "POST", body: fd}).then(r => r.json()).then((resp) => {
      if(resp.success) location.reload();
    });
  });
};
function dataURLtoBlob(dataurl) {
  var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
      bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  while(n--) u8arr[n] = bstr.charCodeAt(n);
  return new Blob([u8arr], {type:mime});
}

var map = L.map('mymap').setView([52.4064, 16.9252], 15);
L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: 'Map data © OpenStreetMap contributors'
  }
).addTo(map);

var wmsUrl = "https://integracja.gugik.gov.pl/cgi-bin/KrajowaIntegracjaUzbrojeniaTerenu";
var warstwy = {
  "wodo":  L.tileLayer.wms(wmsUrl, {layers: "kiut:KIUT_SIECWODOC", format: "image/png", transparent: true, version: "1.1.1"}),
  "kanal": L.tileLayer.wms(wmsUrl, {layers: "kiut:KIUT_SIECKANAL", format: "image/png", transparent: true, version: "1.1.1"}),
  "gaz":   L.tileLayer.wms(wmsUrl, {layers: "kiut:KIUT_SIECGAZ", format: "image/png", transparent: true, version: "1.1.1"}),
  "el":    L.tileLayer.wms(wmsUrl, {layers: "kiut:KIUT_SIECELEKTRO", format: "image/png", transparent: true, version: "1.1.1"}),
  "cieplo":L.tileLayer.wms(wmsUrl, {layers: "kiut:KIUT_SIECCIEPL", format: "image/png", transparent: true, version: "1.1.1"}),
  "tel":   L.tileLayer.wms(wmsUrl, {layers: "kiut:KIUT_SIECTELKOM", format: "image/png", transparent: true, version: "1.1.1"}),
};
for (var k in warstwy) {
  var checkbox = document.getElementById(k);
  if (checkbox && checkbox.checked) warstwy[k].addTo(map);
  var row = checkbox.parentElement;
  var sq = row.querySelector('.cbx-color');
  var c = sq.getAttribute('data-cbx');
  checkbox.addEventListener('change', function() {
    var sq = this.parentElement.querySelector('.cbx-color');
    var c = sq.getAttribute('data-cbx');
    sq.style.setProperty('--active-color', this.checked ? c : '#fff');
  });
  sq.style.setProperty('--active-color', checkbox.checked ? c : '#fff');
}
document.getElementById("layers-form").addEventListener("change", function(e) {
  var id = e.target.id;
  if (e.target.checked) warstwy[id] && warstwy[id].addTo(map);
  else warstwy[id] && map.removeLayer(warstwy[id]);
});

// MARKERY — textarea, podgląd, schludne RÓWNE PRZYCISKI i BIND tekstu
let markerCount = 1;
map._markers = [];
map.on('click', function(e) {
  var marker = L.marker(e.latlng).addTo(map);
  marker._label = "";
  marker._id = markerCount++;
  marker._popupContent = ""; // domyślnie pusty tekst
  var html =
    `<div>
      <textarea id="marker-inp-${marker._id}" class="large-label-textarea" rows="4" placeholder="Wpisz tekst..."></textarea>
      <div id="preview-label-${marker._id}" class="px-1" style="margin:10px 0 2px 0; min-height:22px; font-size:1em; white-space:pre-line;"></div>
      <div style="display:flex; gap:16px; justify-content:center; width:100%;margin-top:6px;">
        <button type="button" id="del-marker-btn-${marker._id}" class="btn btn-delete rounded-pill fw-bold" style="flex:1 1 0; max-width:160px; height:44px;">Usuń znacznik</button>
        <button type="button" id="close-marker-btn-${marker._id}" class="btn btn-light rounded-pill fw-bold" style="flex:1 1 0; max-width:160px; height:44px; border:2px solid #ddd;">Zamknij</button>
      </div>
    </div>`;
  marker.bindPopup(html, {closeButton:false, minWidth:370, maxWidth:400, className:'popup-terlan'}).openPopup();
  marker.on('popupopen', function(evt){
    var textarea = document.getElementById(`marker-inp-${marker._id}`);
    var previewDiv = document.getElementById(`preview-label-${marker._id}`);
    textarea.value = marker._label;
    previewDiv.innerHTML = marker._label.replace(/\n/g, "<br>");
    textarea.oninput = function(){
      marker._label = textarea.value;
      previewDiv.innerHTML = textarea.value.replace(/\n/g, "<br>");
    };
    var delbtn = document.getElementById(`del-marker-btn-${marker._id}`);
    var closebtn = document.getElementById(`close-marker-btn-${marker._id}`);
    delbtn.onclick = function(){ map.removeLayer(marker); };
    closebtn.onclick = function(){
      marker._label = textarea.value;
      marker.closePopup();
    };
  });
  marker.on('popupclose', function(evt){
    // Zapisuje ostatni tekst marker._label po zamknięciu
    marker._label = marker._label || "";
  });
  map._markers.push(marker);
});

// POWIĘKSZANIE ZRZUTU
document.querySelectorAll('.previewImg').forEach(function(img){
  img.addEventListener('mouseenter', function(){
    var pv = document.getElementById('big-preview');
    pv.style.display = 'flex'; pv.querySelector('img').src = img.src;
  });
  img.addEventListener('mouseleave', function(){
    setTimeout(function(){ document.getElementById('big-preview').style.display = 'none'; }, 180);
  });
});
document.getElementById('big-preview').addEventListener('mouseleave', function(){ this.style.display = 'none'; });

// USUWANIE ZRZUTU MAPY
document.querySelectorAll('.delete-snap-btn').forEach(function(btn){
  btn.addEventListener('click', function(e){
    e.preventDefault();
    if(confirm('Czy na pewno usunąć ten zrzut mapy?')) {
      var tr = btn.closest('tr');
      var fname = tr.getAttribute('data-snapfile');
      fetch('/delete_map_snap', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: fname })
      }).then(r => r.json()).then(resp => { if(resp.success) tr.remove(); });
    }
  });
});
</script>
{% endblock %}
