{% extends 'base.html' %}
{% block content %}
<style>
.btn-terlan {
  background: linear-gradient(90deg, #f9d423 30%, #ffdc80 100%);
  color: #644000;
  font-weight: 600;
  border: none;
  box-shadow: 0 3px 18px -6px #f4c54255;
  transition: background 0.2s;
}
.btn-terlan:hover, .btn-terlan:focus {
  background: linear-gradient(90deg, #ffdc80 30%, #f9d423 100%);
  color: #3a2a00;
  box-shadow: 0 4px 24px -8px #f4c54299;
}
@media (max-width: 1350px) {
  .ai-card-main { max-width:98vw !important; }
}
@media (max-width: 900px) {
  .ai-card-row { flex-direction: column !important; align-items: stretch !important; }
  .ai-card-btns { flex-direction: row !important; margin-left: 0 !important; justify-content: flex-end !important; }
}
.custom-hr {
  border: none;
  border-top: 3px solid #d3a900;
  margin: 0 0 16px -36px;
  width: 99.7%;
  align-self: flex-start;
  box-shadow: 0 2px 6px -3px #d3a90055;
}
.progress {
  height: 18px;
  border-radius: 12px;
  background: #ececec;
  overflow: hidden;
  margin-top: 8px; margin-bottom:2px;
}
.progress-bar {
  background: #27c46b;
  color: #fff;
  font-weight: 600;
  font-size: 1em;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: width .5s;
}
.spinner-border {
  width: 28px; height:28px;
  margin-top: 4px;
  vertical-align: middle;
  color: #27c46b;
}
</style>

<div class="d-flex justify-content-center">
  <div class="card shadow-soft rounded-4 px-4 pt-4 pb-1 ai-card-main"
       style="width:100%; max-width:1350px; margin:32px 0 0 0; background:#fff;">
    <h2 class="mb-2" style="position:relative;">Analizy AI</h2>
    <hr class="custom-hr">
    {% for file in files %}
      <div class="card shadow-none border-0 mb-0 px-2" style="background: #fafcff; border-radius: 18px;">
        <div class="card-body d-flex align-items-center ai-card-row px-1 py-3" style="gap:18px; flex-direction:row; flex-wrap:wrap;">
          <div class="flex-grow-1 text-break" style="min-width:180px;">
            <div class="fs-5 fw-semibold mb-1">üéûÔ∏è {{ file.nazwa }}</div>
            <small class="text-muted">
              Dodano: {{ file.data_dodania if file.data_dodania != "-" else "Brak danych" }}<br>
              Analiza: {{ file.data_analizy if file.data_analizy != "-" else "Brak" }}<br>
              Status:
              <span id="status-{{ file.nazwa }}">
                {% if file.status == "W toku" %}
                  <span class="badge bg-warning text-dark ms-1 align-middle">W toku</span>
                {% elif file.status == "Wykonany" %}
                  <span class="badge ms-1 align-middle" style="background:#27c46b; color:#fff; font-weight:600;">Wykonany</span>
                {% else %}
                  <span class="badge bg-secondary ms-1 align-middle">Oczekuje</span>
                {% endif %}
              </span>
            </small>
            <div class="mt-3" id="progressbox-{{ file.nazwa }}"></div>
            {% if file.status == "Wykonany" %}
              <div class="mt-3">
                <video width="350" controls style="border-radius:11px;outline:none;">
                  <source src="{{ url_for('result', filename=file.nazwa) }}" type="video/mp4">
                  Tw√≥j system nie wspiera mp4.
                </video>
                <a href="{{ url_for('result', filename=file.nazwa) }}" class="btn btn-terlan mt-2 px-4 rounded-pill" download>
                  Pobierz wynik
                </a>
              </div>
            {% endif %}
          </div>
          <div class="d-flex flex-column align-items-end ai-card-btns" style="min-width:180px; margin-left:auto;">
            <button class="btn btn-terlan rounded-pill mb-2 px-4"
              onclick="startAnalysis('{{ file.nazwa }}')" id="btn-{{ file.nazwa }}">Wykonaj Analizƒô AI</button>
            <button class="btn btn-danger rounded-pill px-4"
              onclick="stopAnalysis('{{ file.nazwa }}')"
              id="btn-stop-{{ file.nazwa }}" style="display:none;">Stop</button>
          </div>
        </div>
      </div>
      {% if not loop.last %}
        <div class="d-flex justify-content-center">
          <hr class="my-1" style="width:96%; border-top:1.5px solid #e6eaee; opacity:1;">
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>

<script>
const progressTimers = {};
function updateStatus(filename) {
  fetch(`/progress/${filename}`)
    .then(r => r.json())
    .then(data => {
      let pct = data.progress || 0;
      let status_html;
      if(data.done)
        status_html = '<span class="badge" style="background:#27c46b; color:#fff; font-weight:600;">Wykonany</span>';
      else if(data.stopped)
        status_html = '<span class="badge bg-danger">Przerwano</span>';
      else if(pct>0)
        status_html = '<span class="badge bg-warning text-dark">W toku</span>';
      else
        status_html = '<span class="badge bg-secondary">Oczekuje</span>';
      document.getElementById("status-"+filename).innerHTML = status_html;

      // Pasek/spinner
      let bar = '';
      if ((pct > 0 && !data.done && !data.stopped)) {
        bar = `<div class="progress"><div class="progress-bar" style="width:${pct}%;font-size:.97em;font-weight:600">${pct}%</div></div>
               <div class="d-flex align-items-center gap-2 mt-2"><div class="spinner-border" role="status"></div>
               <span class="ms-2 text-muted small" style="font-weight:500;">Trwa analiza‚Ä¶</span></div>`;
      } else if (data.done) {
        bar = `<div class="progress"><div class="progress-bar" style="width:100%;background:#27c46b">${pct}%</div></div>`;
      } else {
        bar = "";
      }
      document.getElementById("progressbox-"+filename).innerHTML = bar;

      document.getElementById("btn-"+filename).disabled = (pct>0 && !data.done && !data.stopped);
      document.getElementById("btn-stop-"+filename).style.display = (pct>0 && !data.done && !data.stopped) ? '' : 'none';

      if(data.done || data.stopped || pct>=100) {
        if(progressTimers[filename]) clearTimeout(progressTimers[filename]);
        return;
      }
      progressTimers[filename] = setTimeout(()=>updateStatus(filename), 800);
    });
}
function startAnalysis(filename){
  fetch('/start_analysis/'+filename,{method:'POST'}).then(_=>{
    setTimeout(()=>updateStatus(filename), 500);
  });
}
function stopAnalysis(filename){
  fetch('/stop_analysis/'+filename, {method:'POST'}).then(_=>{
    setTimeout(()=>updateStatus(filename), 400);
  });
}
document.addEventListener('DOMContentLoaded',function(){
  {% for file in files %}
    {% if file.status == "W toku" %}
      updateStatus('{{ file.nazwa }}');
    {% endif %}
  {% endfor %}
});
</script>
{% endblock %}
